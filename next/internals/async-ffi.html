
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="async-overview.html">
      
      
        <link rel="next" href="rendering_foreign_bindings.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>UniFFI Async FFI details - The UniFFI user guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#uniffi-async-ffi-details" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="The UniFFI user guide" class="md-header__button md-logo" aria-label="The UniFFI user guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The UniFFI user guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              UniFFI Async FFI details
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/mozilla/uniffi-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="The UniFFI user guide" class="md-nav__button md-logo" aria-label="The UniFFI user guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The UniFFI user guide
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mozilla/uniffi-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Motivation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Motivation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Getting_started.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/Prerequisites.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prerequisites
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/udl_file.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Describing the interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/Rust_scaffolding.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rust scaffolding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/foreign_language_bindings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Foreign-language bindings
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    UniFFI type model
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            UniFFI type model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/namespace.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Namespace
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/builtin_types.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Built-in types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/enumerations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Enumerations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/records.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Records
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Functions
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Functions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/functions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/errors.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Throwing errors
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interfaces, Objects and Traits
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/callback_interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callback interfaces
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/remote_ext_types.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Remote and External types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/custom_types.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/defaults.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Default values
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Describing the interface
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Describing the interface
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../describing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Describing the interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    UDL Files
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            UDL Files
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The UDL file
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/enumerations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Enums in UDL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/errors.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Errors in UDL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/functions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functions in UDL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interfaces in UDL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/records.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Records in UDL
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/external_types.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using types defined outside a UDL.
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/docstrings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docstrings
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Proc macros
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Proc macros
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Procedural Macros: Attributes and Derives
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/enumerations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Enumerations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/errors.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The uniffi::Error derive
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/functions.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functions, Constructors, Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/interfaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The uniffi::Object derive
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/records.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The uniffi::Record derive
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/docstrings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Docstrings
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../futures.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Async/Future support
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Bindings
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Bindings
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bindings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Generating bindings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../foreign_traits.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Foreign traits
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Kotlin
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Kotlin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kotlin/configuration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kotlin/gradle.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integrating with Gradle
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kotlin/lifetimes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kotlin Lifetimes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Swift
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Swift
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Swift Bindings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/uniffi-bindgen-swift.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    uniffi-bindgen-swift
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/configuration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/module.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compiling a Swift module
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/xcode.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integrating with Xcode
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/configuration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    WASM
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            WASM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../wasm/configuration.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WASM
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Internals
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Internals
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="design_principles.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design Principles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="crates.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Navigating the code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lifting_and_lowering.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lifting, Lowering and Serialization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="ffi_converter_traits.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ffi converter traits
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="rust_calls.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Foreign -&gt; Rust calls
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="foreign_calls.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rust -&gt; Foreign calls
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="object_references.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Managing Object References
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="async-overview.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    UniFFI Async Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    UniFFI Async FFI details
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="async-ffi.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    UniFFI Async FFI details
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#rust-async-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Rust async functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rust async functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cancellation" class="md-nav__link">
    <span class="md-ellipsis">
      Cancellation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-the-rustfuture-handle" class="md-nav__link">
    <span class="md-ellipsis">
      Managing the RustFuture handle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ffi-definitions" class="md-nav__link">
    <span class="md-ellipsis">
      FFI definitions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FFI definitions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scaffolding-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Scaffolding functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rust_future_poll" class="md-nav__link">
    <span class="md-ellipsis">
      rust_future_poll
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-rustfuture-ffi-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Other RustFuture FFI functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#foreign-async-callback-interface-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Foreign async callback interface methods
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Foreign async callback interface methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#completing-async-methods-with-complete_func" class="md-nav__link">
    <span class="md-ellipsis">
      Completing async methods with complete_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cancellation-with-foreign_future_dropped_callback" class="md-nav__link">
    <span class="md-ellipsis">
      Cancellation with foreign_future_dropped_callback
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-the-foreignfuture-handle" class="md-nav__link">
    <span class="md-ellipsis">
      Managing the ForeignFuture handle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="rendering_foreign_bindings.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rendering Foreign Bindings
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Upgrading.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Upgrading v0.28.x -&gt; v0.29.x
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#rust-async-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Rust async functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rust async functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cancellation" class="md-nav__link">
    <span class="md-ellipsis">
      Cancellation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-the-rustfuture-handle" class="md-nav__link">
    <span class="md-ellipsis">
      Managing the RustFuture handle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ffi-definitions" class="md-nav__link">
    <span class="md-ellipsis">
      FFI definitions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FFI definitions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scaffolding-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Scaffolding functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rust_future_poll" class="md-nav__link">
    <span class="md-ellipsis">
      rust_future_poll
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-rustfuture-ffi-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Other RustFuture FFI functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#foreign-async-callback-interface-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Foreign async callback interface methods
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Foreign async callback interface methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#completing-async-methods-with-complete_func" class="md-nav__link">
    <span class="md-ellipsis">
      Completing async methods with complete_func
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cancellation-with-foreign_future_dropped_callback" class="md-nav__link">
    <span class="md-ellipsis">
      Cancellation with foreign_future_dropped_callback
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-the-foreignfuture-handle" class="md-nav__link">
    <span class="md-ellipsis">
      Managing the ForeignFuture handle
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="uniffi-async-ffi-details">UniFFI Async FFI details</h1>
<p>This document describes the low-level FFI details of UniFFI async calls.
Check out <a href="async-overview.html">Async overview</a> for high-level description of what's going on
here.</p>
<h2 id="rust-async-functions">Rust async functions</h2>
<p>Rust async functions are implemented by a <a href="../glossary.html#scaffolding">scaffolding</a> function that return a <code>RustFuture</code> handle.
For example, a <code>fn add(a: u32, b: u32) -&gt; u32</code> function would be implemented by something like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">ffi_add</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">uniffi</span><span class="p">::</span><span class="n">Handle</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Creates a future for the `add` function and returns handle that represents that handle.</span>
<span class="p">}</span>
</code></pre></div>
<p>The <a href="../glossary.html#bindings">bindings</a> then sets up an asynchronous loop that polls the RustFuture until it's complete.</p>
<p>Here's some Python code that shows how this works:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># Get a future handle by calling the scaffolding function</span>
    <span class="n">rust_future_handle</span> <span class="o">=</span> <span class="n">RustScaffoldingLibrary</span><span class="o">.</span><span class="n">ffi_add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># asynchronously loop until the future is ready</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># create a future to handle a single iteration of the polling loop.</span>
            <span class="n">inner_future</span> <span class="o">=</span> <span class="n">eventloop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
            <span class="c1"># Create a handle to send to Rust that represents `inner_future`</span>
            <span class="n">inner_future_handle</span> <span class="o">=</span> <span class="n">create_future_handle</span><span class="p">(</span><span class="n">inner_future</span><span class="p">)</span>
            <span class="c1"># Call the rust_future_poll scaffolding function (see below for how that&#39;s handled).</span>
            <span class="n">RustScaffoldingLibrary</span><span class="o">.</span><span class="n">ffi_rust_future_poll_u32</span><span class="p">(</span>
                <span class="n">rust_future_handle</span><span class="p">,</span>
                <span class="n">uniffi_continuation_callback</span><span class="p">,</span>
                <span class="n">inner_future_handle</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># await the inner future.  When this completes, there&#39;s are 2 possibilities:</span>
            <span class="c1">#  * The RustFuture is ready and we can complete it</span>
            <span class="c1">#  * The RustFuture should be polled again and we should perform another iteration</span>
            <span class="n">poll_code</span> <span class="o">=</span> <span class="k">await</span> <span class="n">inner_future</span>
            <span class="k">if</span> <span class="n">poll_code</span> <span class="o">==</span> <span class="n">_UNIFFI_RUST_FUTURE_POLL_READY</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Call the complete function to get:</span>
        <span class="c1">#   * The future&#39;s return value</span>
        <span class="c1">#   * The call status -- returned by an out pointer and used to return errors.</span>
        <span class="n">call_status</span> <span class="o">=</span> <span class="n">UniffiRustCallStatus</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="n">RustScaffoldingLibrary</span><span class="o">.</span><span class="n">rust_future_complete_u32</span><span class="p">(</span><span class="n">rust_future_handle</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">call_status</span><span class="p">))</span>

        <span class="c1"># We can then lift the result the same way we would a sync call</span>
        <span class="k">return</span> <span class="n">lift_result</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">call_status</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># In the finally block, we call `rust_future_free` to ensure we cleanup the future handle</span>
        <span class="c1"># regardless of any errors</span>
        <span class="n">RustScaffoldingLibrary</span><span class="o">.</span><span class="n">rust_future_free_u32</span><span class="p">(</span><span class="n">rust_future_handle</span><span class="p">)</span>

<span class="c1"># Continuation callback, this is called from Rust when progress can be made on the future, either</span>
<span class="c1"># because it&#39;s ready or it needs to be polled again.</span>
<span class="k">def</span> <span class="nf">uniffi_continuation_callback</span><span class="p">(</span><span class="n">future_handle</span><span class="p">,</span> <span class="n">poll_code</span><span class="p">):</span>
    <span class="c1"># Convert the handle we sent to Rust to a Python Future</span>
    <span class="n">future</span> <span class="o">=</span> <span class="n">get_future_from_handle</span><span class="p">(</span><span class="n">future_handle</span><span class="p">)</span>
    <span class="c1"># Complete the future with the code that indicates if the future is ready or not.</span>
    <span class="n">eventloop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">,</span> <span class="n">poll_code</span><span class="p">)</span>

<span class="c1"># Create a `u64` handle that represents a Python Future object.</span>
<span class="k">def</span> <span class="nf">create_future_handle</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
    <span class="c1"># The code to do this will vary by language.</span>

<span class="c1"># Re-create the Python Future object from a `u64` handle.</span>
<span class="k">def</span> <span class="nf">get_future_from_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">):</span>
    <span class="c1"># The code to do this will vary by language.</span>
</code></pre></div>
<h3 id="cancellation">Cancellation</h3>
<p>Some languages have builtin cancellation semantics.  For those, you can call the
<code>rust_future_cancel</code> to request that the future be cancelled.  On the Rust side, this causes the
future to be dropped.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">cancel_future</span><span class="p">(</span><span class="n">future_handle</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rust_future_has_not_been_freed</span><span class="p">(</span><span class="n">future_handle</span><span class="p">):</span>
        <span class="n">RustScaffoldingLibrary</span><span class="o">.</span><span class="n">rust_future_cancel_u32</span><span class="p">(</span><span class="n">rust_future_handle</span><span class="p">)</span>
</code></pre></div>
<h3 id="managing-the-rustfuture-handle">Managing the RustFuture handle</h3>
<ul>
<li>The foreign code is responsible for calling the <code>rust_future_free</code> function when it's done with the handle.
  The code must always call <code>rust_future_free</code>, regardless of if the future is completed or cancelled.
  Once that function is called, the handle must not be used again.</li>
<li><code>rust_future_complete</code> must only be called once.  Once it's called, <code>rust_future_poll</code> should not
  be called again.</li>
<li>If your bindings call <code>rust_future_cancel</code> make sure there are no races that allow it to be called
  after <code>rust_future_free</code>.</li>
</ul>
<h3 id="ffi-definitions">FFI definitions</h3>
<h4 id="scaffolding-functions">Scaffolding functions</h4>
<div class="highlight"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">scaffolding_function_name</span><span class="p">](</span>
<span class="w">    </span><span class="c1">// The lowered type for each argument of the Rust function</span>
<span class="w">    </span><span class="n">foo</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="n">bar</span><span class="p">:</span><span class="w"> </span><span class="nc">RustBuffer</span><span class="p">,</span>
<span class="w">    </span><span class="c1">// No `RustCallStatus` argument.  Errors are handled by calling the `rust_future_complete`</span>
<span class="w">    </span><span class="c1">// function.</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// Returns a RustFuture handle</span>
</code></pre></div>
<h4 id="rust_future_poll">rust_future_poll</h4>
<p>A <code>rust_future_poll</code> method is defined for each lowered return type.  For example:
<div class="highlight"><pre><span></span><code><span class="sd">/// `rust_future_poll` for return types that lower to `RustBuffer`.  This handles exported functions</span>
<span class="sd">/// that return `String`, `Vec`, records, etc.</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rust_future_poll_rustbuffer</span><span class="p">(</span>
<span class="w">    </span><span class="n">rust_future_handle</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="sd">/// Callback to call when progress can be made to the future</span>
<span class="w">    </span><span class="n">continuation_callback</span><span class="p">:</span><span class="w"> </span><span class="nc">RustFutureContinuationCallback</span><span class="p">,</span>
<span class="w">    </span><span class="sd">/// Data to pass to the continuation callback</span>
<span class="w">    </span><span class="n">continuation_callback_data</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="k">type</span><span class="w"> </span><span class="nc">RustFutureContinuationCallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">callback_data</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">poll_code</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span>

<span class="c1">// The future is ready, call `rust_future_complete`</span>
<span class="k">const</span><span class="w"> </span><span class="n">POLL_CODE_RUST_FUTURE_READY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="c1">// Wake the future by calling `rust_future_poll` again.</span>
<span class="k">const</span><span class="w"> </span><span class="n">POLL_CODE_RUST_FUTURE_WAKE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</code></pre></div></p>
<h4 id="other-rustfuture-ffi-functions">Other RustFuture FFI functions</h4>
<div class="highlight"><pre><span></span><code><span class="sd">/// `rust_future_complete` for return types that lower to `u8`</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rust_future_complete_u8</span><span class="p">(</span>
<span class="w">    </span><span class="n">rust_future_handle</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="sd">/// RustCallStatus out pointer.  This indicates if the call was successful.</span>
<span class="w">    </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RustCallStatus</span><span class="w"> </span><span class="n">out_status</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// lowered return value, in this case a `u8`.</span>

<span class="sd">/// `rust_future_cancel` for return types that lower to `f32`.</span>
<span class="sd">///</span>
<span class="sd">/// Languages that support cancellation can call this to cancel the future.  It will cause the</span>
<span class="sd">/// `Future` object to be dropped in Rust.</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rust_future_cancel_f32</span><span class="p">(</span>
<span class="w">    </span><span class="n">rust_future_handle</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>

<span class="sd">/// `rust_future_free` for void return types.</span>
<span class="sd">///</span>
<span class="sd">/// This must be called for each RustFuture you receive and it must be the last call you pass the</span>
<span class="sd">/// RustFuture handle to.</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rust_future_free_void</span><span class="p">(</span>
<span class="w">    </span><span class="n">rust_future_handle</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<h2 id="foreign-async-callback-interface-methods">Foreign async callback interface methods</h2>
<p>Async callback interface methods are defined as fields in the callback interface vtable like sync
methods.  However, they have no return value and 3 extra arguments:</p>
<ul>
<li><code>complete_func</code>: Function to call when the async method completes.</li>
<li><code>complete_func_data</code>: <code>u64</code> value to pass to the complete function</li>
<li><code>foreign_future_dropped_callback</code>: Out pointer to the future dropped callback.
  If the foreign bindings set this, it will be called when the Rust future is dropped.
  This is used to handle cancellation for languages that support it.</li>
</ul>
<p>For example: </p>
<div class="highlight"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">CallbackInterfaceVTable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">add</span><span class="p">:</span><span class="w"> </span><span class="nc">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span>
<span class="w">        </span><span class="c1">// The lowered type for each argument of the method</span>
<span class="w">        </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="sd">/// Function pointer for the completion func</span>
<span class="w">        </span><span class="n">complete_func</span><span class="p">:</span><span class="w"> </span><span class="nc">ForeignFutureCompleteU32</span><span class="p">,</span>
<span class="w">        </span><span class="sd">/// Data to pass to the completion func</span>
<span class="w">        </span><span class="n">complete_func_data</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="sd">/// Out pointer that can be used to set the future dropped callback</span>
<span class="w">        </span><span class="n">out_dropped_callback</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">ForeignFutureDroppedCallbackStruct</span><span class="p">,</span>
<span class="w">    </span><span class="p">),</span><span class="w"> </span><span class="c1">// Note: no return value, `complete_func` is used for that.</span>
<span class="w">    </span><span class="c1">// .. other methods here</span>
<span class="p">}</span>

<span class="sd">/// Complete func signature, details in the next section</span>
<span class="k">type</span><span class="w"> </span><span class="nc">ForeignFutureCompleteU32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">ForeignFutureResultU32</span><span class="p">);</span>
</code></pre></div>
<h3 id="completing-async-methods-with-complete_func">Completing async methods with <code>complete_func</code></h3>
<p>The <code>complete_func</code> should be called when the async callback method has completed and ready to
return data.  Pass it 2 arguments:</p>
<ul>
<li>The <code>complete_func_data</code> passed to the callback method.</li>
<li>A foreign future result struct, which contains the return value and the RustCallStatus for the
  call.</li>
</ul>
<p>The foreign future result struct varies based on the return value:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="sd">/// Result struct for `u8` </span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ForeignFutureResultU8</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// Lowered return value.  For error calls, set this to a placeholder value like `0`</span>
<span class="w">    </span><span class="n">return_value</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="sd">/// RustCallStatus.  This indicates if the call was successful or not</span>
<span class="w">    </span><span class="n">call_status</span><span class="p">:</span><span class="w"> </span><span class="nc">RustCallStatus</span><span class="p">,</span>
<span class="p">}</span>

<span class="sd">/// Result struct for `RustBuffer` </span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ForeignFutureResultRustBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// Lowered return value.  For error calls, set this to empty `RustBuffer`.</span>
<span class="w">    </span><span class="n">return_value</span><span class="p">:</span><span class="w"> </span><span class="nc">RustBuffer</span><span class="p">,</span>
<span class="w">    </span><span class="sd">/// RustCallStatus.  This indicates if the call was successful or not</span>
<span class="w">    </span><span class="n">call_status</span><span class="p">:</span><span class="w"> </span><span class="nc">RustCallStatus</span><span class="p">,</span>
<span class="p">}</span>

<span class="sd">/// Result struct for void returns</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">ForeignFutureResultVoid</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// No return value field.</span>

<span class="w">    </span><span class="sd">/// RustCallStatus.  This indicates if the call was successful or not</span>
<span class="w">    </span><span class="n">call_status</span><span class="p">:</span><span class="w"> </span><span class="nc">RustCallStatus</span><span class="p">,</span>
<span class="p">}</span>

<span class="sd">/// ...etc.</span>
</code></pre></div>
<h3 id="cancellation-with-foreign_future_dropped_callback">Cancellation with <code>foreign_future_dropped_callback</code></h3>
<p>The <code>foreign_future_dropped_callback</code> is a pointer to a <code>ForeignFutureDroppedCallbackStruct</code>.
This can be used to get a callback when the underlying Future is dropped in <code>Rust</code>.
The main reason to do this is to cancel the Foreign async task.  If you want to support
cancellation, set the <code>ForeignFutureDroppedCallbackStruct</code> data and connect it to some mechanism for
cancelling the future.</p>
<div class="highlight"><pre><span></span><code>type ForeignFutureDroppedCallback = extern &quot;C&quot; fn(u64);

#[repr(C)]
struct ForeignFutureDroppedCallbackStruct {
    /// Data to pass to the callback
    callback_data: u64,
    /// Callback function pointer
    callback: ForeignFutureDroppedCallback,
}
</code></pre></div>
<p>Languages that don't want to support cancellation are free to ignore this field by not setting a value.</p>
<h3 id="managing-the-foreignfuture-handle">Managing the ForeignFuture handle</h3>
<p>If an async callback method is called, you must ensure that the <code>complete_func</code> is called which will
complete the future and allow the async task to progress.  The <code>complete_func</code> must be called
exactly once.</p>
<p>If you don't want to support cancellation, then managing this handle is fairly easy:</p>
<ul>
<li>Start an async task to execute the method</li>
<li>Chain a function to that task that calls <code>complete_func</code> with the handle when it's complete</li>
<li>Ensure that <code>complete_func</code> is also called if the function errors out.
  In this case you can pass a <code>ForeignFutureResult*</code> value with
  <code>RustCallStatus.code = CallStatus::InternalError</code>.</li>
</ul>
<p>If you want to support cancellation, then there are some additional steps:</p>
<ul>
<li>Create a <code>u64</code> handle for the async task that was started.</li>
<li>Set the <code>foreign_future_dropped_callback</code> with a callback and handle.</li>
<li>In the callback:</li>
<li>Cancel the task if it's still running</li>
<li>Release the handle in whatever way the foreign language requires</li>
<li>Note: this callback can be called after the task completes. You may need to avoid calling
     methods that are invalid for completed tasks.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>