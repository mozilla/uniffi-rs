
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="object_references.html">
      
      
        <link rel="next" href="rendering_foreign_bindings.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.22">
    
    
      
        <title>UniFFI Async internals - The UniFFI user guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.732c4fb1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#uniffi-async-internals" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="The UniFFI user guide" class="md-header__button md-logo" aria-label="The UniFFI user guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The UniFFI user guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              UniFFI Async internals
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/mozilla/uniffi-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="The UniFFI user guide" class="md-nav__button md-logo" aria-label="The UniFFI user guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    The UniFFI user guide
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mozilla/uniffi-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Motivation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Motivation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Getting_started.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/Prerequisites.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prerequisites
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/udl_file.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Describing the interface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/Rust_scaffolding.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rust scaffolding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/foreign_language_bindings.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Foreign-language bindings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    UniFFI type model
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            UniFFI type model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/namespace.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Namespace
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/builtin_types.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Built-in types
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/enumerations.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enumerations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/records.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Records
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Functions
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Functions
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/functions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/errors.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Throwing errors
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/interfaces.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interfaces, Objects and Traits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/callback_interfaces.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Callback interfaces
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/remote_ext_types.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Remote and External types
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../types/custom_types.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom types
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Describing the interface
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Describing the interface
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../describing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Describing the interface
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    UDL Files
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            UDL Files
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The UDL file
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/enumerations.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enums in UDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/errors.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Errors in UDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/functions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functions in UDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/interfaces.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interfaces in UDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/records.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Records in UDL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../udl/docstrings.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docstrings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Proc macros
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Proc macros
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Procedural Macros: Attributes and Derives
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/enumerations.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enumerations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/errors.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The uniffi::Error derive
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/functions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Functions, Constructors, Methods
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/interfaces.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The uniffi::Object derive
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/records.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The uniffi::Record derive
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proc_macro/docstrings.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docstrings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../futures.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Async/Future support
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bindings
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Bindings
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bindings.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Generating bindings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../foreign_traits.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Foreign traits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Kotlin
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Kotlin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kotlin/configuration.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kotlin/gradle.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrating with Gradle
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kotlin/lifetimes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotlin Lifetimes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Swift
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Swift
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Swift Bindings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/uniffi-bindgen-swift.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    uniffi-bindgen-swift
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/configuration.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/module.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compiling a Swift module
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../swift/xcode.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrating with Xcode
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/configuration.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Internals
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Internals
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="design_principles.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design Principles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="crates.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Navigating the code
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lifting_and_lowering.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lifting, Lowering and Serialization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="object_references.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Managing Object References
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    UniFFI Async internals
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="async.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    UniFFI Async internals
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-runtime-does-async-code-run-on" class="md-nav__link">
    <span class="md-ellipsis">
      What runtime does async code run on?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rust-async-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Rust Async functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rust Async functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-not-have-rust_future_poll-return-a-boolean" class="md-nav__link">
    <span class="md-ellipsis">
      Why not have rust_future_poll return a boolean?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#foreign-async-callback-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Foreign async callback methods
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#can-you-really-just-piggyback-on-the-foreign-async-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Can you really just piggyback on the foreign async runtime?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#can-you-integrating-with-rust-runtimes-like-tokio" class="md-nav__link">
    <span class="md-ellipsis">
      Can you integrating with Rust Runtimes like tokio?
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="rendering_foreign_bindings.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rendering Foreign Bindings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Upgrading.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    v0.28.x -&gt; v0.29.x
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-runtime-does-async-code-run-on" class="md-nav__link">
    <span class="md-ellipsis">
      What runtime does async code run on?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rust-async-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Rust Async functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rust Async functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-not-have-rust_future_poll-return-a-boolean" class="md-nav__link">
    <span class="md-ellipsis">
      Why not have rust_future_poll return a boolean?
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#foreign-async-callback-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Foreign async callback methods
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#can-you-really-just-piggyback-on-the-foreign-async-runtime" class="md-nav__link">
    <span class="md-ellipsis">
      Can you really just piggyback on the foreign async runtime?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#can-you-integrating-with-rust-runtimes-like-tokio" class="md-nav__link">
    <span class="md-ellipsis">
      Can you integrating with Rust Runtimes like tokio?
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="uniffi-async-internals">UniFFI Async internals</h1>
<h2 id="what-runtime-does-async-code-run-on">What runtime does async code run on?</h2>
<p>The fundamental issue here is that UniFFI can't rely on a Rust async runtime.
We don't want to force library authors into a particular runtime.
Furthermore, we want to allow library authors to not use a runtime at all and instead to integrate with the runtime of the application using the library.</p>
<p>To accomplish this, UniFFI piggybacks off the runtime from the foreign bindings.
The generated Rust code schedules work using callbacks provided by the foreign bindings.</p>
<h2 id="rust-async-functions">Rust Async functions</h2>
<p>Rust async functions are implemplemented by wrapping the
<a href="https://doc.rust-lang.org/std/future/trait.Future.html">Future</a> into a <code>uniffi::RustFuture</code> struct
and providing scaffolding functions so that the foreign bindings can drive the future to completion.</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
  participant User as User code
  participant Foreign as Foreign Language Bindings
  participant Rust as Rust Scaffolding

  User-&gt;&gt;+Foreign: call async function
  Foreign-&gt;&gt;+Rust: call scaffolding function
  Rust--&gt;&gt;-Foreign: return RustFuture handle

  loop until RustFuture is ready
    Foreign-&gt;&gt;Rust: call RustFuture poll fn
    Rust-&gt;&gt;Foreign: call future callback
  end

  Foreign-&gt;&gt;+Rust: call RustFuture complete fn
  Rust--&gt;&gt;-Foreign: return result
  Foreign-&gt;&gt;Rust: call RustFuture free fn
  Foreign--&gt;&gt;-User: return from async function
</code></pre></div>
<p>For each async function, UniFFI generates 4 scaffolding functions:
* A scaffolding function that returns a <code>RustFuture</code> handle
* <code>rust_future_poll</code> to poll the future
* <code>rust_future_complete</code> to receive the completed result of a future
* <code>rust_future_free</code> to destroy a future freeing any underlying memory
* Technically, the function names are more like <code>uniffi_[module_prefix]_rust_future_poll</code>, but this document uses above names make for shorthand.</p>
<p>The UniFFI generated code for an async function performs these steps:</p>
<ol>
<li>Call the Rust scaffolding function, receiving a <code>RustFuture</code> handle</li>
<li>Call the <code>rust_future_poll</code> function for the future until the future is ready.</li>
<li>The <code>rust_future_poll</code> function inputs a callback function and an opaque pointer (AKA a <code>void *</code>) to call the callback with.</li>
<li>If the future is pending, then the generated code registers a waker that will call the callback function with <code>RUST_FUTURE_MAYBE_READY</code>.
     When the generated foreign code sees this, it calls poll again, starting the loop over.</li>
<li>If the future is ready, then the callback function is immediately called with <code>RUST_FUTURE_READY</code> and we move to the next step.</li>
<li>Call <code>rust_future_complete</code>, receiving the return value of the future</li>
<li>Call <code>rust_future_free</code> (ideally in a <code>finally</code> block)</li>
<li>Return the result from <code>rust_future_complete</code></li>
</ol>
<h3 id="why-not-have-rust_future_poll-return-a-boolean">Why not have <code>rust_future_poll</code> return a boolean?</h3>
<p>As described above, <code>rust_future_poll</code> inputs a callback and an opaque pointer.
If the future is ready, then <code>rust_future_poll</code> immediately invokes the callback, passing it the pointer back and <code>RUST_FUTURE_READY</code>
A more straightforward API would be to return a boolean if the future is ready, why not do that?</p>
<p>The issue is that it doesn't work well with the way foreign code's lifetime management.
The opaque pointer is usually either something like a raw <code>Arc</code> pointer that holds data about the async call.
When the foreign code passes the pointer to <code>rust_future_poll</code>, it temporarily <a href="https://doc.rust-lang.org/std/sync/struct.Arc.html#method.into_raw">leaks a reference</a>.
Then when callback is called, it <a href="https://doc.rust-lang.org/std/sync/struct.Arc.html#method.from_raw">reconstructs the leaked reference</a>, restoring the refcount.</p>
<p>If <code>rust_future_poll</code> returned <code>true</code> to indicate that the future is ready, then the foreign code is in an awkward situation.
It wants to use the async call data that the pointer was referring to, but it just sent a leaked pointer to Rust.
It would have to hold on to a copy of the raw pointer, use that to restore the reference, and assume the callback is never going to be called.
This could work, but it makes things much more complicated and could easily lead to memory leaks or use-after-free bugs.</p>
<h2 id="foreign-async-callback-methods">Foreign async callback methods</h2>
<p>Async callback/trait interface methods are the way that Rust makes async calls across the FFI.
These are implemented using a callback, which makes them quite a bit simpler than their counterparts.</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
  participant User as User code
  participant Rust as Rust Scaffolding
  participant Foreign as Foreign Language Bindings

  User-&gt;&gt;+Rust: call async function
  Rust-&gt;&gt;Foreign: call scaffolding function, pass a oneshot::Sender pointer
  Rust--&gt;&gt;-User: return oneshot::Receiver

  Foreign-&gt;&gt;Rust: invoke callback, pass back oneshot::Sender pointer
  Note over Rust: send callback result to the oneshot::Sender
</code></pre></div>
<p>The UniFFI generated code for an async trait method performs these steps:</p>
<ul>
<li>Create a <code>oneshot::Channel</code> (see <a href="https://docs.rs/oneshot/latest/oneshot/">oneshot crate</a> for how these work, although we don't currently depend on that crate).</li>
<li>Leak the <code>oneshot::Sender</code> into a raw pointer</li>
<li>Defines an <code>extern "C"</code> function that will:<ul>
<li>input that raw pointer plus a return value </li>
<li>lift the return value</li>
<li>send the return value into the <code>oneshot::Sender</code>.</li>
</ul>
</li>
<li>Call the callback method, passing a pointer to the function from the last step and the <code>oneshot::Sender</code> raw pointer.</li>
<li>Return the receiver half of the <code>oneshot::Channel</code>.</li>
</ul>
<p>On the foreign side, the generated code simply runs the async function as normal, and call the callback once it completes.</p>
<h2 id="can-you-really-just-piggyback-on-the-foreign-async-runtime">Can you really just piggyback on the foreign async runtime?</h2>
<p>It's somewhat surprising, but yes.
All the async code can run in the foreign runtime and Rust never has to start its own eventloop thread.
In order to implement this, the Rust async functions must only await functions that fall into one of these categories:</p>
<ul>
<li>UniFFI async callback/trait methods
  This often means defining traits for things like HTTP clients so that Rust can leverage async HTTP libraries from the foreign side.</li>
<li>Async functions from crates like <a href="https://docs.rs/oneshot/latest/oneshot/">oneshot</a> and <a href="https://docs.rs/async-mutex/latest/async_mutex/">async_mutex</a> that work with any runtime.</li>
</ul>
<p>Beware that some Rust crates will present async APIs that silently start up runtimes in the background.
For example, <a href="https://docs.rs/reqwest/latest/reqwest/">reqwest</a> will start a tokio runtime.</p>
<p>The <a href="https://github.com/mozilla/uniffi-rs/tree/main/examples/async-api-client">Async API client example</a> shows how this could work in the real-world.
The Rust library depends an async HTTP callback interface to do the low-level fetching, then deserializes/validates the HTTP response.
After that, it returns a high-level API response struct to the application.
Furthermore, let's stipulate that the deserialization/validation is slow enough to be considered blocking.
To manage this, the Rust library also depends on a (synchronous) callback interface that runs a task in a worker queue where blocking is allowed.
Here's how the async API call could be handled:</p>
<div class="highlight"><pre><span></span><code>sequenceDiagram
  participant AsyncRust as Async Rust code
  participant SyncRust as Sync Rust code
  participant WorkerQueue as Work Queue Callback Interface
  participant Http as Http Callback Interface
  participant Foreign as Foreign language code

  Foreign-&gt;&gt;+AsyncRust: Start async API call
  AsyncRust-&gt;&gt;+Http: await method of Http callback interface
  Http--&gt;&gt;-AsyncRust: Return HTTP response
  Note over AsyncRust: Create oneshot channel&lt;br/&gt;and deseralization task
  AsyncRust--&gt;&gt;WorkerQueue: Schedule task&lt;br /&gt;(sends the HTTP response for further processing)
  Note over AsyncRust: await oneshot channel
  WorkerQueue-&gt;&gt;SyncRust: Run task (in background thread)
  SyncRust--&gt;&gt;AsyncRust: Send deserialized response via oneshot channel
  AsyncRust--&gt;&gt;-Foreign: Return API result
</code></pre></div>
<ul>
<li>Action in this sequence diagram represents calling an async Rust function or async callback interface method, see the above diagrams for details.</li>
<li>The dotted lines show how the data is passed around during the async call.</li>
<li>The async Rust code runs in a <a href="https://doc.rust-lang.org/std/future/trait.Future.html#tymethod.poll">Future::poll</a> method, inside the foreign event loop.  This code never blocks.</li>
<li>The sync Rust code runs inside a worker queue where it's okay to block.</li>
<li>This all combines together to create an async Rust call that's driven by the foreign event loop.</li>
</ul>
<h2 id="can-you-integrating-with-rust-runtimes-like-tokio">Can you integrating with Rust Runtimes like <code>tokio</code>?</h2>
<p>Yes.  This will vary for each runtime, but the typical procedure is:</p>
<ul>
<li>Keep a reference to the runtime</li>
<li>Use a bridge function like <a href="https://docs.rs/tokio/latest/tokio/runtime/struct.Runtime.html#method.spawn">tokio::Runtime::spawn</a> to await a future that runs in that runtime.</li>
</ul>
<p>There's also the <code>uniffi::async_runtime</code> macro attribute to help with this, but it's not clear if we
want to continue to support it (<a href="https://github.com/mozilla/uniffi-rs/issues/1726">#1726</a>).</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5cfa9459.min.js"></script>
      
    
  </body>
</html>